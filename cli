#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="${SCRIPT_DIR}"
DERIVED_DATA_DIR="${REPO_ROOT}/.build/DerivedData"
PROJECT_PATH="${REPO_ROOT}/Interact.xcodeproj"
SCHEME_NAME="Interact"

usage() {
  cat <<'EOF'
Usage: ./cli <command>

Commands:
  build   Build the Interact application.
  lint    Run SwiftLint on the project sources.
  test    Execute the unit test suite.
EOF
}

ensure_swiftlint() {
  if ! command -v swiftlint >/dev/null 2>&1; then
    echo "error: swiftlint not found on PATH." >&2
    echo "Install SwiftLint (e.g. via Homebrew: brew install swiftlint)." >&2
    exit 1
  fi
}

run_xcodebuild() {
  local action="$1"
  shift

  if ! command -v xcodebuild >/dev/null 2>&1; then
    echo "error: xcodebuild not found on PATH." >&2
    exit 1
  fi

  xcodebuild \
    -project "${PROJECT_PATH}" \
    -scheme "${SCHEME_NAME}" \
    -derivedDataPath "${DERIVED_DATA_DIR}" \
    -sdk macosx \
    CODE_SIGN_IDENTITY="" \
    CODE_SIGNING_REQUIRED=NO \
    CODE_SIGNING_ALLOWED=NO \
    "${action}" "$@"
}

if [[ $# -lt 1 ]]; then
  usage
  exit 1
fi

case "$1" in
  build)
    run_xcodebuild build
    ;;
  lint)
    ensure_swiftlint
    swiftlint lint --quiet
    ;;
  test)
    run_xcodebuild test -destination 'platform=macOS' -skip-testing:InteractUITests
    ;;
  *)
    usage
    exit 1
    ;;
esac
