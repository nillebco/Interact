#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="${SCRIPT_DIR}"
DERIVED_DATA_DIR="${REPO_ROOT}/.build/DerivedData"
PROJECT_PATH="${REPO_ROOT}/Interact.xcodeproj"
SCHEME_NAME="Interact"

usage() {
  cat <<'EOF'
Usage: ./cli <command>

Commands:
  build   Build the Interact application.
  lint    Run SwiftLint on the project sources.
  test    Execute the unit test suite.
EOF
}

ensure_swiftlint() {
  if ! command -v swiftlint >/dev/null 2>&1; then
    echo "error: swiftlint not found on PATH." >&2
    echo "Install SwiftLint (e.g. via Homebrew: brew install swiftlint)." >&2
    exit 1
  fi
}

run_xcodebuild() {
  local action="$1"
  shift

  if ! command -v xcodebuild >/dev/null 2>&1; then
    echo "error: xcodebuild not found on PATH." >&2
    exit 1
  fi

  xcodebuild \
    -project "${PROJECT_PATH}" \
    -scheme "${SCHEME_NAME}" \
    -derivedDataPath "${DERIVED_DATA_DIR}" \
    -sdk macosx \
    CODE_SIGN_IDENTITY="" \
    CODE_SIGNING_REQUIRED=NO \
    CODE_SIGNING_ALLOWED=NO \
    "${action}" "$@"
}

if [[ $# -lt 1 ]]; then
  usage
  exit 1
fi

case "$1" in
  build)
    run_xcodebuild build
    ;;
  lint)
    ensure_swiftlint
    mkdir -p "${REPO_ROOT}/.build/swiftlint" \
      "${REPO_ROOT}/.build/home/Library/Developer/Xcode/DerivedData" \
      "${REPO_ROOT}/.build/tmp"
    LATEST_LOG=""
    for log_file in $(ls -t "${REPO_ROOT}"/.build/DerivedData/Logs/Build/*.xcactivitylog 2>/dev/null); do
      if [[ -s "${log_file}" ]]; then
        LATEST_LOG="${log_file}"
        break
      fi
    done
    if [[ -n "${LATEST_LOG}" ]]; then
      TEMP_LOG="${REPO_ROOT}/.build/tmp/swiftlint-compiler-log.xcactivitylog"
      /usr/bin/env python3 - "$LATEST_LOG" "$TEMP_LOG" <<'PY'
import gzip
import shutil
import sys

source, destination = sys.argv[1], sys.argv[2]
with gzip.open(source, "rb") as zipped, open(destination, "wb") as unzipped:
    shutil.copyfileobj(zipped, unzipped)
PY
      SWIFTLINT_CACHE_PATH="${REPO_ROOT}/.build/swiftlint/cache" \
        HOME="${REPO_ROOT}/.build/home" \
        TMPDIR="${REPO_ROOT}/.build/tmp" \
        swiftlint analyze --quiet --compiler-log-path "${TEMP_LOG}"
      rm -f "${TEMP_LOG}"
    else
      SWIFTLINT_CACHE_PATH="${REPO_ROOT}/.build/swiftlint/cache" \
        HOME="${REPO_ROOT}/.build/home" \
        TMPDIR="${REPO_ROOT}/.build/tmp" \
        swiftlint lint --quiet
    fi
    ;;
  test)
    run_xcodebuild test -destination 'platform=macOS' -only-testing:InteractTests -skip-testing:InteractUITests
    ;;
  *)
    usage
    exit 1
    ;;
esac
